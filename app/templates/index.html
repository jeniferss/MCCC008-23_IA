<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dosis:wght@200..800&family=Leckerli+One&display=swap"
          rel="stylesheet">
    <title>personIA</title>
    <style>
        :root {
            --primary: #150259;
        }

        body, html {
            height: 100%;
            font-family: 'Dosis', sans-serif;
        }

        .page-wrapper {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
        }

        .main-card {
            width: 100%;
            max-width: 900px;
            min-width: 300px;
            border: 0;
        }

        #results {
            display: none;
            margin-top: 1rem;
        }

        .avatar {
            width: clamp(56px, 6vw, 128px);
            aspect-ratio: 1 / 1;
            height: auto;
            object-fit: cover;
            display: block;
            margin: 0 auto 0 auto;
        }

        .main-title {
            font-family: 'Leckerli One', cursive;
            letter-spacing: 1px;
        }

        .main-title .caret {
            display: inline-block;
            width: 0.12em;
            margin-left: 0.18em;
            background-color: currentColor;
            vertical-align: middle;
            animation: blink 1s steps(1) infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }

        input, textarea, button, select, .card, .card-body, .card-text, h2, h5 {
            font-family: 'Dosis', sans-serif;
        }

        .form-control:focus {
            outline: none;
            box-shadow: none !important;
            border-color: var(--primary);
        }

        .btn-info {
            background-color: transparent !important;
            border: none !important;
            color: var(--primary) !important;
            padding: 0.4rem 0.65rem;
        }

        .btn-info:hover, .btn-info:focus {
            background-color: #ede8ff !important;
            color: var(--primary) !important;
        }

        .btn-info .spinner-border {
            color: var(--primary);
        }

        .card.characteristic-card {
            background-color: #d5c9ff;
            border: none;
            color: var(--primary);
        }

        .card.characteristic-card .card-body {
            background: transparent;
            color: inherit;
        }

        .progress-bar {
            background-color: var(--primary) !important;
        }
    </style>
</head>
<body>
<div class="page-wrapper">
    <div class="card main-card shadow-sm">
        <div class="card-body">
            <img id="avatarImg" src="" alt="avatar" class="avatar"/>
            <h1 class="card-title main-title text-center"><span class="typed" aria-live="polite"></span><span
                    class="ellipsis" aria-hidden="true"></span><span class="caret" aria-hidden="true"></span></h1>
            <p class="card-text text-center lead">Cole um trecho de livro e descubra as características do
                personagem</p>

            <form id="analyzeForm">
                <div class="mb-3">
                    <label for="textInput" class="visually-hidden">Trecho do livro</label>
                    <textarea
                            class="form-control"
                            id="textInput"
                            rows="8"
                            required
                            placeholder="Falo a partir de onde o corpo repousa, e por isso posso começar pela extremidade em que muitos preferem calar: o túmulo. Não finjo teatralidade; digo apenas que a morte facilitou meu discurso — não me compete mais agradar, e sim confessar. Entre a laje e a terra, houve tempo para pensar, ou melhor, para ver as coisas com a calma de quem já não precisa preocupar‑se com opiniões. O defunto observa o trabalho dos vermes, a prática silenciosa da decomposição, e aprende que grandeza e pequenez se tornam igualitárias sob a ação lenta do tempo. Não é horror que me move, mas curiosidade serena: o que o fim fez de minha vaidade, de meus projetos? O túmulo não mente; é um espelho que devolve apenas o que sobrou do homem..."
                    ></textarea>
                </div>
                <div class="d-grid gap-2">
                    <button type="submit" id="analyzeBtn" class="btn btn-info btn-lg">
                        <span id="btnText"><strong>Analisar Personagem</strong></span>
                        <span id="btnSpinner" class="spinner-border spinner-border-sm ms-2" role="status"
                              style="display:none;" aria-hidden="true"></span>
                    </button>
                </div>
            </form>

            <div class="error mt-3 text-danger" id="error" role="alert" style="display:none;"></div>

            <div class="results" id="results">
                <h2 class="h5">Características Identificadas</h2>
                <div class="row" id="characteristicsRow">
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const form = document.getElementById('analyzeForm');
    const textInput = document.getElementById('textInput');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const btnText = document.getElementById('btnText');
    const btnSpinner = document.getElementById('btnSpinner');
    const avatarImg = document.getElementById('avatarImg');
    const results = document.getElementById('results');
    const characteristicsRow = document.getElementById('characteristicsRow');
    const errorDiv = document.getElementById('error');
    const mainTitleTyped = document.querySelector('.main-title .typed');
    const mainTitleEllipsis = document.querySelector('.main-title .ellipsis');
    const mainTitleCaret = document.querySelector('.main-title .caret');

    function setLoading(isLoading) {
        if (isLoading) {
            analyzeBtn.disabled = true;
            btnSpinner.style.display = 'inline-block';
            btnText.innerHTML = '<strong>Analisando...</strong>';
        } else {
            analyzeBtn.disabled = false;
            btnSpinner.style.display = 'none';
            btnText.innerHTML = '<strong>Analisar Personagem</strong>';
        }
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const text = textInput.value.trim();
        if (!text) return;

        results.style.display = 'none';
        errorDiv.style.display = 'none';
        characteristicsRow.innerHTML = '';
        setLoading(true);

        try {
            const response = await fetch('/api/v1/prediction/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({text})
            });

            if (!response.ok) {
                throw new Error('Erro ao analisar o texto');
            }

            const data = await response.json();
            displayResults(data);

        } catch (error) {
            errorDiv.textContent = 'Erro ao analisar o texto. Por favor, tente novamente.';
            errorDiv.style.display = 'block';
        } finally {
            setLoading(false);
        }
    });

    function displayResults(data) {
        characteristicsRow.innerHTML = '';

        const labels = Array.isArray(data.labels) ? data.labels : [];
        const scores = data.scores || {};

        let chosen = labels.slice(0, 2);

        if (chosen.length > 1) {
            chosen = chosen.sort((a, b) => (scores[b] || 0) - (scores[a] || 0));
        }

        while (chosen.length < 2) chosen.push(null);

        chosen.forEach((label) => {
            const col = document.createElement('div');
            col.className = 'col-12 col-md-6';

            const card = document.createElement('div');
            card.className = 'card characteristic-card h-100';

            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';

            if (label) {
                const score = scores[label] || 0;
                const percentage = Math.round(score * 100);

                cardBody.innerHTML = `
                    <h5 class="card-title">${capitalize(label)}</h5>
                    <p class="card-text">Confiança: <strong>${percentage}%</strong></p>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: ${percentage}%" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100">${percentage}%</div>
                    </div>
                `;
            } else {
                cardBody.innerHTML = `
                    <h5 class="card-title text-muted">—</h5>
                    <p class="card-text text-muted">Nenhuma característica identificada</p>
                `;
            }

            card.appendChild(cardBody);
            col.appendChild(card);
            characteristicsRow.appendChild(col);
        });

        results.style.display = 'block';
    }

    function capitalize(str) {
        if (!str) return '';
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function randomSeed() {
        try {
            const arr = new Uint32Array(2);
            crypto.getRandomValues(arr);
            return Array.from(arr).map(n => n.toString(36)).join('').slice(0, 10);
        } catch (e) {
            return Math.random().toString(36).substring(2, 12);
        }
    }

    function setAvatar(seed) {
        const base = 'https://api.dicebear.com/9.x/adventurer/svg';
        avatarImg.src = `${base}?seed=${encodeURIComponent(seed)}&t=${Date.now()}`;
    }

    function typeText(el, text, speed = 70) {
        if (!el) return Promise.resolve();
        el.textContent = '';
        let i = 0;
        return new Promise(resolve => {
            function step() {
                if (i <= text.length - 1) {
                    el.textContent += text.charAt(i);
                    i += 1;
                    setTimeout(step, speed);
                } else {
                    resolve();
                }
            }

            step();
        });
    }

    function startEllipsisLoop(el, interval = 500) {
        if (!el) return;
        const states = ['', '.', '..', '...'];
        let idx = 0;
        el.textContent = '';
        return setInterval(() => {
            el.textContent = states[idx % states.length];
            idx += 1;
        }, interval);
    }

    document.addEventListener('DOMContentLoaded', async () => {
        setAvatar(randomSeed());
        await typeText(mainTitleTyped, 'personIA', 80);
        if (mainTitleCaret) mainTitleCaret.style.opacity = '1';
        startEllipsisLoop(mainTitleEllipsis, 500);
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>
</body>
</html>
